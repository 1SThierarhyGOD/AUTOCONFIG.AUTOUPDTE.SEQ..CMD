<Project Sdk="Microsoft.DotNet.Helix.Sdk" InitialTargets="ProvisionDotNetCoverage;BuildHelixWorkItems" DefaultTargets="Test">

  <PropertyGroup>
    <Language>msbuild</Language>

    <_workItemTimeout>00:20:00</_workItemTimeout>
    <WorkItemArchiveWildCard>$(TestArchiveTestsDir)**/*.zip</WorkItemArchiveWildCard>

    <IncludeDotNetCli>true</IncludeDotNetCli>
    <DotNetCliPackageType>sdk</DotNetCliPackageType>

    <GlobalJsonContent>$([System.IO.File]::ReadAllText('$(RepoRoot)global.json'))</GlobalJsonContent>
    <DotNetCliVersion>$([System.Text.RegularExpressions.Regex]::Match($(GlobalJsonContent), '(%3F&lt;="dotnet": ").*(%3F=")'))</DotNetCliVersion>

    <DotNetCoverageToolVersion>17.9.3</DotNetCoverageToolVersion>
  </PropertyGroup>

  <PropertyGroup>
    <_HelixLogPath Condition="'$(OS)' != 'Windows_NT'">$HELIX_WORKITEM_UPLOAD_ROOT/log</_HelixLogPath>
    <_HelixLogPath Condition="'$(OS)' == 'Windows_NT'">%HELIX_WORKITEM_UPLOAD_ROOT%/log</_HelixLogPath>

    <_HelixCorrelationPayloadEnvVar Condition="'$(OS)' != 'Windows_NT'">$HELIX_CORRELATION_PAYLOAD</_HelixCorrelationPayloadEnvVar>
    <_HelixCorrelationPayloadEnvVar Condition="'$(OS)' == 'Windows_NT'">%HELIX_CORRELATION_PAYLOAD%</_HelixCorrelationPayloadEnvVar>

    <_TestCoverageCommand>$(_HelixCorrelationPayloadEnvVar)/dotnet-coverage/dotnet-coverage collect</_TestCoverageCommand>

    <_TestCoverageCommand>$(_TestCoverageCommand) --settings $(_HelixCorrelationPayloadEnvVar)/CodeCoverage.config</_TestCoverageCommand>
    <_TestCoverageCommand>$(_TestCoverageCommand) --output $(_HelixLogPath)/Test.cobertura.xml</_TestCoverageCommand>
  </PropertyGroup>

  <ItemGroup>
    <_TestRunCommandArguments Include="dotnet test" />

    <_TestRunCommandArguments Condition="'$(OS)' != 'Windows_NT'" Include="$TEST_NAME.dll" />
    <_TestRunCommandArguments Condition="'$(OS)' == 'Windows_NT'" Include="%TEST_NAME%.dll" />

    <_TestRunCommandArguments Include="--ResultsDirectory:$(_HelixLogPath)" />

    <_TestRunCommandArguments Condition="'$(OS)' != 'Windows_NT'" Include="'--logger:console%3Bverbosity=normal'" />
    <_TestRunCommandArguments Condition="'$(OS)' == 'Windows_NT'" Include="--logger:console%3Bverbosity=normal" />
    <_TestRunCommandArguments Condition="'$(OS)' != 'Windows_NT'" Include="'--logger:trx%3BLogFileName=TestResults.trx'" />
    <_TestRunCommandArguments Condition="'$(OS)' == 'Windows_NT'" Include="--logger:trx%3BLogFileName=TestResults.trx" />
  </ItemGroup>

  <Target Name="BuildHelixWorkItems">
    <ItemGroup>
      <HelixCorrelationPayload Include="$(_DotNetCoverageToolPath)" Destination="dotnet-coverage" />
      <HelixCorrelationPayload Include="$(RepoRoot)eng/CodeCoverage.config" />

      <_DefaultWorkItems Include="$(WorkItemArchiveWildCard)" />
      <!--<_DefaultWorkItems Condition="'$(ContinuousIntegrationBuild)' != 'true'" Include="$(RepoRoot)artifacts/helix/tests/Aspire.Hosting.Tests.zip" />-->

      <HelixWorkItem Include="@(_DefaultWorkItems -> '%(FileName)')">
        <PayloadArchive>%(Identity)</PayloadArchive>
        <PreCommands Condition="'$(OS)' == 'Windows_NT'">set &quot;TEST_NAME=%(FileName)&quot;</PreCommands>
        <PreCommands Condition="'$(OS)' != 'Windows_NT'">export &quot;TEST_NAME=%(FileName)&quot;</PreCommands>
        <Command Condition="'$(RunWithCodeCoverage)' == 'true'">$(_TestCoverageCommand) &quot;@(_TestRunCommandArguments, ' ')&quot;</Command>
        <Command Condition="'$(RunWithCodeCoverage)' != 'true'">@(_TestRunCommandArguments, ' ')</Command>
        <Timeout>$(_workItemTimeout)</Timeout>
      </HelixWorkItem>
    </ItemGroup>
  </Target>

  <Target Name="ProvisionDotNetCoverage">
    <InstallDotNetTool Name="dotnet-coverage"
                       DestinationPath="$(ArtifactsDir)/tools"
                       Version="$(DotNetCoverageToolVersion)"
                       WorkingDirectory="$(ArtifactsTmpDir)"
                       DotNetPath="$(DotNetTool)"
                       NoCache="$(XHarnessNoCache)">
      <Output TaskParameter="ToolPath" PropertyName="_DotNetCoverageToolPath" />
    </InstallDotNetTool>
  </Target>
</Project>
