<Project Sdk="Microsoft.DotNet.Helix.Sdk" DefaultTargets="Test">

  <PropertyGroup>
    <Language>msbuild</Language>

    <_workItemTimeout>00:20:00</_workItemTimeout>
    <WorkItemArchiveWildCard>$(TestArchiveTestsDir)**/*.zip</WorkItemArchiveWildCard>

    <IncludeDotNetCli>true</IncludeDotNetCli>
    <DotNetCliPackageType>sdk</DotNetCliPackageType>

    <GlobalJsonContent>$([System.IO.File]::ReadAllText('$(RepoRoot)global.json'))</GlobalJsonContent>
    <DotNetCliVersion>$([System.Text.RegularExpressions.Regex]::Match($(GlobalJsonContent), '(%3F&lt;="dotnet": ").*(%3F=")'))</DotNetCliVersion>
  </PropertyGroup>

  <ItemGroup>
    <HelixPreCommand Condition="'$(OS)' != 'Windows_NT'" Include="export ASPIRE_HOSTING_TEST_PROJECT_BASE_PATH=$HELIX_CORRELATION_PAYLOAD/testassets/testproject" />
    <HelixPreCommand Condition="'$(OS)' == 'Windows_NT'" Include="set ASPIRE_HOSTING_TEST_PROJECT_BASE_PATH=%HELIX_CORRELATION_PAYLOAD%\testassets\testproject" />
  </ItemGroup>

  <PropertyGroup>
    <HelixPreCommands>$(HelixPreCommands);@(HelixPreCommand)</HelixPreCommands>

    <_TestRunCommandArguments Condition="'$(OS)' == 'Windows_NT'">&quot;--ResultsDirectory:$HELIX_WORKITEM_UPLOAD_ROOT/log&quot;</_TestRunCommandArguments>
    <_TestRunCommandArguments Condition="'$(OS)' != 'Windows_NT'">&quot;--ResultsDirectory:%HELIX_WORKITEM_UPLOAD_ROOT%/log&quot;</_TestRunCommandArguments>
    <_TestRunCommandArguments>$(_TestRunCommandArguments) &quot;--Framework:.NETCoreApp,Version=v8.0&quot;</_TestRunCommandArguments>
    <_TestRunCommandArguments>$(_TestRunCommandArguments) --logger:console</_TestRunCommandArguments>
  </PropertyGroup>

  <ItemGroup>
    <HelixCorrelationPayload Include="testproject" Destination="testassets/testproject" />

    <_DefaultWorkItems Include="$(WorkItemArchiveWildCard)" />
    <!--<_DefaultWorkItems Condition="'$(ContinuousIntegrationBuild)' != 'true'" Include="$(RepoRoot)artifacts/helix/tests/Aspire.Hosting.Tests.zip" />-->

    <HelixWorkItem Include="@(_DefaultWorkItems -> '%(FileName)')">
      <PayloadArchive>$(TestArchiveTestsDir)%(Identity).zip</PayloadArchive>
      <Command>dotnet test %(Identity).dll $(_TestRunCommandArguments)</Command>
      <Timeout>$(_workItemTimeout)</Timeout>
    </HelixWorkItem>
  </ItemGroup>
</Project>
