<Project Sdk="Microsoft.DotNet.Helix.Sdk" DefaultTargets="Test">

  <PropertyGroup>
    <Language>msbuild</Language>

    <_workItemTimeout>00:20:00</_workItemTimeout>
    <WorkItemArchiveWildCard>$(TestArchiveTestsDir)**/*.zip</WorkItemArchiveWildCard>

    <IncludeDotNetCli>true</IncludeDotNetCli>
    <DotNetCliPackageType>sdk</DotNetCliPackageType>

    <GlobalJsonContent>$([System.IO.File]::ReadAllText('$(RepoRoot)global.json'))</GlobalJsonContent>
    <DotNetCliVersion>$([System.Text.RegularExpressions.Regex]::Match($(GlobalJsonContent), '(%3F&lt;="dotnet": ").*(%3F=")'))</DotNetCliVersion>
  </PropertyGroup>

  <PropertyGroup>
    <_HelixLogPath Condition="'$(OS)' != 'Windows_NT'">$HELIX_WORKITEM_UPLOAD_ROOT/log</_HelixLogPath>
    <_HelixLogPath Condition="'$(OS)' == 'Windows_NT'">%HELIX_WORKITEM_UPLOAD_ROOT%/log</_HelixLogPath>

    <_TestCoverageCommand>dotnet dotnet-coverage collect</_TestCoverageCommand>
    <_TestCoverageCommand>$(_TestCoverageCommand) --settings $(RepoRoot)eng/CodeCoverage.config</_TestCoverageCommand>
    <_TestCoverageCommand>$(_TestCoverageCommand) --output $(_HelixLogPath)/Test.cobertura.xml.</_TestCoverageCommand>

    <_TestRunCommandArguments>dotnet test</_TestRunCommandArguments>
    <_TestRunCommandArguments Condition="'$(OS)' != 'Windows_NT'">$(_TestRunCommandArguments) $TEST_NAME.dll</_TestRunCommandArguments>
    <_TestRunCommandArguments Condition="'$(OS)' == 'Windows_NT'">$(_TestRunCommandArguments) %TEST_NAME%.dll</_TestRunCommandArguments>

    <_TestRunCommandArguments>$(_TestRunCommandArguments) --ResultsDirectory:$(_HelixLogPath)</_TestRunCommandArguments>
    <_TestRunCommandArguments>$(_TestRunCommandArguments) '--logger:console%3Bverbosity=normal'</_TestRunCommandArguments>
    <_TestRunCommandArguments>$(_TestRunCommandArguments) '--logger:trx%3BLogFileName=TestResults.trx'</_TestRunCommandArguments>
  </PropertyGroup>

  <ItemGroup>
    <_DefaultWorkItems Include="$(WorkItemArchiveWildCard)" />
    <!--<_DefaultWorkItems Condition="'$(ContinuousIntegrationBuild)' != 'true'" Include="$(RepoRoot)artifacts/helix/tests/Aspire.Hosting.Tests.zip" />-->

    <HelixWorkItem Include="@(_DefaultWorkItems -> '%(FileName)')">
      <PayloadArchive>$(TestArchiveTestsDir)%(Identity).zip</PayloadArchive>
      <PreCommands Condition="'$(OS)' == 'Windows_NT'">set &quot;TEST_NAME=%(Identity)&quot;</PreCommands>
      <PreCommands Condition="'$(OS)' != 'Windows_NT'">export &quot;TEST_NAME=%(Identity)&quot;</PreCommands>
      <Command Condition="'$(RunWithCodeCoverage)' == 'true'">$(_TestCoverageCommand) &quot;$(_TestRunCommandArguments)&quot;</Command>
      <Command Condition="'$(RunWithCodeCoverage)' != 'true'">$(_TestRunCommandArguments)</Command>
      <Timeout>$(_workItemTimeout)</Timeout>
    </HelixWorkItem>
  </ItemGroup>
</Project>
